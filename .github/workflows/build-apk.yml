# Rotating Art Launcher (RAL) å®˜æ–¹å¯¹é½æ„å»ºå·¥ä½œæµ
name: Build RAL APK (Official Match)

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'æ„å»ºç±»å‹ï¼ˆå®˜æ–¹é€šå¸¸æ˜¯ Releaseï¼‰'
        required: true
        default: 'release'  # é»˜è®¤æ”¹ä¸º releaseï¼Œä¸å®˜æ–¹ä¸€è‡´
        type: choice
        options:
          - release    # ä¸å®˜æ–¹ä¸€è‡´
          - debug      # ä»…è°ƒè¯•ä½¿ç”¨

env:
  ANDROID_COMPILE_SDK: "36"
  ANDROID_BUILD_TOOLS: "36.0.0"
  ANDROID_NDK_VERSION: "28.0.13004108"
  ANDROID_CMAKE_VERSION: "3.22.1"

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      contents: read
      actions: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          cmdline-tools-version: "latest"

      - name: Install SDK & NDK
        run: |
          sdkmanager --install \
            "platforms;android-${ANDROID_COMPILE_SDK}" \
            "build-tools;${ANDROID_BUILD_TOOLS}" \
            "ndk;${ANDROID_NDK_VERSION}" \
            "cmake;${ANDROID_CMAKE_VERSION}"
          yes | sdkmanager --licenses || true

      # å…³é”®ï¼šæ ¹æ®è¾“å…¥é€‰æ‹©æ„å»ºç±»å‹ï¼Œé»˜è®¤ Releaseï¼ˆä¸å®˜æ–¹ä¸€è‡´ï¼‰
      - name: Build APK
        id: build_step
        run: |
          chmod +x ./gradlew
          
          if [ "${{ github.event.inputs.build_type }}" == "debug" ]; then
            echo "ğŸ”¨ æ„å»º Debug ç‰ˆæœ¬ï¼ˆä»…ä¾›è°ƒè¯•ï¼‰"
            ./gradlew assembleDebug --no-daemon --stacktrace
            APK_PATH="app/build/outputs/apk/debug"
            APK_PATTERN="*-debug.apk"
          else
            echo "ğŸ”¨ æ„å»º Release ç‰ˆæœ¬ï¼ˆä¸å®˜æ–¹ä¸€è‡´ï¼‰"
            # Release æ¨¡å¼ä¼šè§¦å‘ build.gradle ä¸­çš„ä¼˜åŒ–é…ç½®ï¼š
            # - CMAKE_BUILD_TYPE=Releaseï¼ˆä¼˜åŒ–è¿‡çš„ Native åº“ï¼‰
            # - æ— è°ƒè¯•ç¬¦å·
            ./gradlew assembleRelease --no-daemon --stacktrace
            APK_PATH="app/build/outputs/apk/release"
            APK_PATTERN="*-release-unsigned.apk"  # æœªç­¾åç‰ˆæœ¬
          fi
          
          # æ‰¾åˆ° APK æ–‡ä»¶
          APK_FILE=$(find $APK_PATH -name "*.apk" | head -n 1)
          echo "apk_path=$APK_FILE" >> $GITHUB_OUTPUT
          echo "build_type=${{ github.event.inputs.build_type || 'release' }}" >> $GITHUB_OUTPUT

      # ä¸Šä¼ äº§ç‰©
      - name: Upload APK
        if: steps.build_step.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: RAL-${{ github.event.inputs.build_type || 'release' }}-${{ github.run_id }}
          path: ${{ steps.build_step.outputs.apk_path }}
          retention-days: 30

      # æ„å»ºæŠ¥å‘Š
      - name: Build Report
        if: always()
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          
          if [ "${{ steps.build_step.outcome }}" == "success" ]; then
            BUILD_TYPE="${{ github.event.inputs.build_type || 'release' }}"
            
            if [ "$BUILD_TYPE" == "release" ]; then
              echo "â•‘     âœ… Release æ„å»ºæˆåŠŸï¼ˆä¸å®˜æ–¹ä¸€è‡´ï¼‰                  â•‘"
              echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
              echo "â•‘  âš ï¸  æ³¨æ„ï¼šè¿™æ˜¯æœªç­¾åç‰ˆæœ¬ï¼Œå®‰è£…å‰éœ€è¦ç­¾å              â•‘"
              echo "â•‘     æˆ–ä½¿ç”¨è°ƒè¯•ç­¾åï¼š                                   â•‘"
              echo "â•‘     keytool -genkey -v ...                             â•‘"
              echo "â•‘     apksigner sign --ks debug.jks ...                  â•‘"
            else
              echo "â•‘     âœ… Debug æ„å»ºæˆåŠŸï¼ˆä»…ä¾›è°ƒè¯•ï¼‰                      â•‘"
              echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
              echo "â•‘  ğŸ’¡ æç¤ºï¼šDebug ç‰ˆæœ¬å¯ä»¥ç›´æ¥å®‰è£…è°ƒè¯•                   â•‘"
            fi
            
            echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
            echo "â•‘  ğŸ“¥ ä¸‹è½½åœ°å€ï¼š                                         â•‘"
            echo "â•‘  ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID} â•‘"
          else
            echo "â•‘              âŒ æ„å»ºå¤±è´¥                               â•‘"
            echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
            echo "â•‘  ğŸ” æŸ¥çœ‹é”™è¯¯ï¼š                                         â•‘"
            echo "â•‘  ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID} â•‘"
          fi
          
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          [ "${{ steps.build_step.outcome }}" != "success" ] && exit 1
