# Rotating Art Launcher (RAL) å…¨è‡ªåŠ¨APKæ„å»ºå·¥ä½œæµ - å®Œæ•´ä¿®å¤ç‰ˆ
name: RAL Full Auto Build APK

on:
  push:
    branches: [ main, master ]
    paths-ignore:
      - '**.md'
      - '**.txt'
      - 'LICENSE'
      - 'icons/**'
      - 'docs/**'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'æ„å»ºç±»å‹ (debug/release/all)'
        required: true
        default: 'debug'
        type: choice
        options:
          - debug
          - release
          - all

env:
  ANDROID_COMPILE_SDK: "28"
  ANDROID_BUILD_TOOLS: "34.0.0"
  # å…³é”®ä¿®å¤ï¼šä¸é¡¹ç›®build.gradleä¸­çš„ndkVersionä¿æŒä¸€è‡´ï¼ˆ28.0.13004108ï¼‰
  ANDROID_NDK_VERSION: "28.0.13004108"
  ANDROID_CMAKE_VERSION: "3.22.1"
  GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.parallel=true -Dorg.gradle.jvmargs=-Xmx6g -XX:MaxMetaspaceSize=512m"

jobs:
  build-apk:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    permissions:
      contents: read
      actions: write

    steps:
      # 1. æ‹‰å–ä»£ç ï¼ˆå«å­æ¨¡å—ï¼‰
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      # 2. æ ¡éªŒé¡¹ç›®ç»“æ„
      - name: Validate Project Structure
        run: |
          echo "ğŸ” æ ¡éªŒRALé¡¹ç›®æ ¸å¿ƒæ–‡ä»¶..."
          if [ ! -f "./gradlew" ]; then
            echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ°gradlewæ–‡ä»¶" && exit 1
          fi
          if [ ! -d "./app" ]; then
            echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ°appæ¨¡å—ç›®å½•" && exit 1
          fi
          echo "âœ… é¡¹ç›®ç»“æ„æ ¡éªŒé€šè¿‡"

      # 3. é…ç½®JDK 17
      - name: Set Up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      # 4. è®¾ç½®åŸºç¡€Androidç¯å¢ƒï¼ˆå…³é”®ä¿®å¤ï¼šä¸é€šè¿‡packageså‚æ•°å®‰è£…ï¼‰
      - name: Setup Android SDK (Base)
        uses: android-actions/setup-android@v3
        with:
          cmdline-tools-version: "latest"
          # æ³¨æ„ï¼šæ­¤å¤„ä¸æŒ‡å®špackageså‚æ•°ï¼Œé¿å…è§£æé”™è¯¯

      # 5. å®‰è£…SDKç»„ä»¶ï¼ˆæ‰‹åŠ¨å®‰è£…ï¼Œç¡®ä¿ç‰ˆæœ¬æ­£ç¡®ï¼‰
      - name: Install SDK Components
        run: |
          echo "ğŸ“¦ æ­£åœ¨å®‰è£…Android SDKç»„ä»¶..."
          echo "   - Platform: android-${ANDROID_COMPILE_SDK}"
          echo "   - Build Tools: ${ANDROID_BUILD_TOOLS}"
          echo "   - NDK: ${ANDROID_NDK_VERSION}"
          echo "   - CMake: ${ANDROID_CMAKE_VERSION}"
          
          # ä½¿ç”¨sdkmanageré€ä¸ªå®‰è£…ï¼ˆé¿å…packageså‚æ•°è§£æé—®é¢˜ï¼‰
          sdkmanager --install \
            "platforms;android-${ANDROID_COMPILE_SDK}" \
            "build-tools;${ANDROID_BUILD_TOOLS}" \
            "platform-tools" \
            "ndk;${ANDROID_NDK_VERSION}" \
            "cmake;${ANDROID_CMAKE_VERSION}" \
            --channel=0
          
          # éªŒè¯å®‰è£…
          echo "âœ… å·²å®‰è£…ç»„ä»¶åˆ—è¡¨ï¼š"
          sdkmanager --list_installed | grep -E "(ndk|build-tools|platforms|cmake)" || true

      # 6. æ¥å—SDKè®¸å¯è¯ï¼ˆé™é»˜æ¨¡å¼ï¼‰
      - name: Accept SDK Licenses
        run: |
          yes | sdkmanager --licenses || true
          echo "âœ… SDKè®¸å¯è¯å·²æ¥å—"

      # 7. é…ç½®Local Propertiesï¼ˆå…³é”®ï¼šç¡®ä¿NDKè·¯å¾„æ­£ç¡®ï¼‰
      - name: Configure Local Properties
        run: |
          echo "sdk.dir=${ANDROID_SDK_ROOT}" > local.properties
          echo "ndk.dir=${ANDROID_SDK_ROOT}/ndk/${ANDROID_NDK_VERSION}" >> local.properties
          echo "cmake.dir=${ANDROID_SDK_ROOT}/cmake/${ANDROID_CMAKE_VERSION}" >> local.properties
          echo "::group::Local Propertieså†…å®¹"
          cat local.properties
          echo "::endgroup::"

      # 8. ä¼˜åŒ–Gradleç¼“å­˜
      - name: Cache Gradle Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            .gradle/caches
            .gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties', '**/libs.versions.toml') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      # 9. å‡†å¤‡æ„å»ºç¯å¢ƒ
      - name: Prepare Build Environment
        run: |
          chmod +x ./gradlew
          echo "Gradleç‰ˆæœ¬ä¿¡æ¯ï¼š"
          ./gradlew --version
          echo "æ¸…ç†æ—§æ„å»º..."
          ./gradlew clean --quiet

      # 10. æ„å»ºDebugç‰ˆAPKï¼ˆé»˜è®¤ï¼‰
      - name: Build Debug APK
        if: github.event.inputs.build_type == 'debug' || github.event.inputs.build_type == 'all' || github.event_name != 'workflow_dispatch'
        id: build_debug
        run: |
          echo "ğŸš€ å¼€å§‹æ„å»ºDebugç‰ˆAPK..."
          ./gradlew assembleDebug --stacktrace --no-daemon --build-cache
          
          # æŸ¥æ‰¾APK
          DEBUG_APK=$(find app/build/outputs/apk/debug -name "*.apk" -type f | head -n 1)
          if [ -z "$DEBUG_APK" ]; then
            echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ°Debug APKè¾“å‡º"
            exit 1
          fi
          
          APK_SIZE=$(du -h "$DEBUG_APK" | cut -f1)
          echo "âœ… Debug APKæ„å»ºæˆåŠŸ"
          echo "   è·¯å¾„: $DEBUG_APK"
          echo "   å¤§å°: $APK_SIZE"
          echo "debug_apk_path=$DEBUG_APK" >> $GITHUB_OUTPUT
          echo "debug_apk_size=$APK_SIZE" >> $GITHUB_OUTPUT

      # 11. æ„å»ºReleaseç‰ˆAPKï¼ˆå¯é€‰ï¼Œæœªç­¾åï¼‰
      - name: Build Release APK
        if: github.event.inputs.build_type == 'release' || github.event.inputs.build_type == 'all'
        id: build_release
        continue-on-error: true
        run: |
          echo "ğŸš€ å¼€å§‹æ„å»ºReleaseç‰ˆAPKï¼ˆæœªç­¾åï¼‰..."
          ./gradlew assembleRelease --stacktrace --no-daemon --build-cache
          
          RELEASE_APK=$(find app/build/outputs/apk/release -name "*.apk" -type f | head -n 1)
          if [ -z "$RELEASE_APK" ]; then
            echo "âš ï¸ è­¦å‘Šï¼šRelease APKæœªç”Ÿæˆï¼ˆå¯èƒ½éœ€è¦ç­¾åé…ç½®ï¼‰"
            exit 0
          fi
          
          APK_SIZE=$(du -h "$RELEASE_APK" | cut -f1)
          echo "âœ… Release APKæ„å»ºæˆåŠŸ"
          echo "   è·¯å¾„: $RELEASE_APK"
          echo "   å¤§å°: $APK_SIZE"
          echo "release_apk_path=$RELEASE_APK" >> $GITHUB_OUTPUT
          echo "release_apk_size=$APK_SIZE" >> $GITHUB_OUTPUT

      # 12. ä¸Šä¼ æ„å»ºäº§ç‰©
      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: RAL-APKs-${{ github.run_id }}-${{ github.event.inputs.build_type || 'debug' }}
          path: |
            app/build/outputs/apk/**/*.apk
            app/build/outputs/mapping/**/mapping.txt
          retention-days: 30
          if-no-files-found: warn
          compression-level: 6

      # 13. æ„å»ºæ€»ç»“æŠ¥å‘Š
      - name: Build Summary
        if: always()
        run: |
          echo "::group::ğŸ“Š RALæ„å»ºæ€»ç»“æŠ¥å‘Š"
          echo "å·¥ä½œæµè¿è¡ŒID: ${{ github.run_id }}"
          echo "è§¦å‘æ–¹å¼: ${{ github.event_name }}"
          echo "æ„å»ºç±»å‹: ${{ github.event.inputs.build_type || 'debug' }}"
          echo "Gitæäº¤: ${{ github.sha }}"
          echo "----------------------------------------"
          
          if [ -n "${{ steps.build_debug.outputs.debug_apk_path }}" ]; then
            echo "âœ… Debug APK"
            echo "   æ–‡ä»¶: ${{ steps.build_debug.outputs.debug_apk_path }}"
            echo "   å¤§å°: ${{ steps.build_debug.outputs.debug_apk_size }}"
          else
            echo "âŒ Debug APK: æœªæ„å»ºæˆ–å¤±è´¥"
          fi
          
          if [ -n "${{ steps.build_release.outputs.release_apk_path }}" ]]; then
            echo "âœ… Release APK"
            echo "   æ–‡ä»¶: ${{ steps.build_release.outputs.release_apk_path }}"
            echo "   å¤§å°: ${{ steps.build_release.outputs.release_apk_size }}"
          else
            echo "âš ï¸ Release APK: æœªæ„å»º"
          fi
          echo "::endgroup::"
