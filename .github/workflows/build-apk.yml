name: Build RAL APK (Debug & Release)

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  ANDROID_COMPILE_SDK: "36"
  ANDROID_BUILD_TOOLS: "36.0.0"
  ANDROID_NDK_VERSION: "28.0.13004108"
  ANDROID_CMAKE_VERSION: "3.22.1"

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      contents: read
      actions: write

    steps:
      # ==================== ç¯å¢ƒå‡†å¤‡ ====================
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          lfs: true

      - name: Setup JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install SDK Components
        run: |
          sdkmanager --install \
            "platforms;android-${ANDROID_COMPILE_SDK}" \
            "build-tools;${ANDROID_BUILD_TOOLS}" \
            "ndk;${ANDROID_NDK_VERSION}" \
            "cmake;${ANDROID_CMAKE_VERSION}"
          yes | sdkmanager --licenses || true

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      # ==================== Debug æ„å»º ====================
      - name: Build Debug APK
        run: |
          echo "ğŸš€ å¼€å§‹æ„å»º Debug ç‰ˆæœ¬..."
          ./gradlew clean assembleDebug --no-daemon --stacktrace

      - name: Verify Debug APK
        run: |
          ls -lh app/build/outputs/apk/debug/
          echo "Debug APK ä¿¡æ¯ï¼š"
          ${ANDROID_SDK_ROOT}/build-tools/${ANDROID_BUILD_TOOLS}/aapt dump badging app/build/outputs/apk/debug/app-debug.apk | head -1 || true

      - name: Upload Debug APK
        uses: actions/upload-artifact@v4
        with:
          name: RAL-Debug-${{ github.run_id }}
          path: app/build/outputs/apk/debug/app-debug.apk
          retention-days: 30
          if-no-files-found: error

      # ==================== Release æ„å»º ====================
      - name: Generate Debug Keystore for Release
        run: |
          keytool -genkey -v \
            -keystore debug.keystore \
            -alias androiddebugkey \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000 \
            -storepass android \
            -keypass android \
            -dname "CN=Android Debug, O=Android, C=US"

      - name: Build Release APK
        run: |
          echo "ğŸš€ å¼€å§‹æ„å»º Release ç‰ˆæœ¬..."
          ./gradlew assembleRelease --no-daemon --stacktrace

      - name: Sign Release APK with Debug Key
        run: |
          UNSIGNED_APK="app/build/outputs/apk/release/app-release-unsigned.apk"
          
          if [ ! -f "$UNSIGNED_APK" ]; then
            UNSIGNED_APK=$(find app/build/outputs/apk/release -name "*-unsigned.apk" | head -1)
          fi
          
          if [ -z "$UNSIGNED_APK" ] || [ ! -f "$UNSIGNED_APK" ]; then
            echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ°æœªç­¾å APK"
            ls -la app/build/outputs/apk/release/ || true
            exit 1
          fi
          
          SIGNED_APK="${UNSIGNED_APK%-unsigned.apk}-signed.apk"
          echo "ğŸ”‘ æ­£åœ¨ç­¾å: $UNSIGNED_APK"
          
          ${ANDROID_SDK_ROOT}/build-tools/${ANDROID_BUILD_TOOLS}/apksigner sign \
            --ks debug.keystore \
            --ks-key-alias androiddebugkey \
            --ks-pass pass:android \
            --key-pass pass:android \
            --out "${SIGNED_APK}" \
            "${UNSIGNED_APK}"
          
          ${ANDROID_SDK_ROOT}/build-tools/${ANDROID_BUILD_TOOLS}/apksigner verify -v "${SIGNED_APK}"
          rm -f "${UNSIGNED_APK}" "${UNSIGNED_APK}.idsig" 2>/dev/null || true
          
          echo "âœ… Release APK å·²ç­¾å: ${SIGNED_APK}"

      - name: Upload Release APK
        uses: actions/upload-artifact@v4
        with:
          name: RAL-Release-DebugSigned-${{ github.run_id }}
          path: app/build/outputs/apk/release/*-signed.apk
          retention-days: 30
          if-no-files-found: error

      # ==================== æ„å»ºæ‘˜è¦ ====================
      - name: Build Summary
        run: |
          echo "========================================"
          echo "âœ… åŒç‰ˆæœ¬æ„å»ºå®Œæˆ"
          echo "========================================"
          echo ""
          echo "ğŸ“¦ Debug APK (å¼€å‘è°ƒè¯•):"
          echo "   æ–‡ä»¶å: app-debug.apk"
          echo "   ç­¾å: Android Debug Key (è‡ªåŠ¨)"
          echo ""
          echo "ğŸ“¦ Release APK (æ€§èƒ½ä¼˜åŒ–):"
          echo "   æ–‡ä»¶å: app-release-signed.apk"
          echo "   ç­¾å: Android Debug Key (æ‰‹åŠ¨)"
          echo "   ç‰¹æ€§: ä»£ç ä¼˜åŒ–ã€èµ„æºå‹ç¼©"
          echo ""
          echo "ğŸ“¥ ä¸‹è½½åœ°å€:"
          echo "   ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
          echo "========================================"
